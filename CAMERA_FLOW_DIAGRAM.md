# RealSense Camera Flow - Visual Diagram

## ğŸ”„ Complete System Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SESSION MANAGER                               â”‚
â”‚                                                                   â”‚
â”‚  1. Mobile app connects â†’ Pre-warm camera                        â”‚
â”‚  2. Start validation â†’ Activate camera (if not pre-warmed)       â”‚
â”‚  3. Collect frames for 10s                                       â”‚
â”‚  4. Select best frame                                            â”‚
â”‚  5. Deactivate camera                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SIMPLE REALSENSE SERVICE (Async)                    â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚          HARDWARE LIFECYCLE MANAGER               â”‚          â”‚
â”‚  â”‚  â€¢ Reference counting (multiple sources)          â”‚          â”‚
â”‚  â”‚  â€¢ Activate: sum(requests) > 0                    â”‚          â”‚
â”‚  â”‚  â€¢ Deactivate: sum(requests) == 0                 â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                              â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚            PREVIEW LOOP (Background Task)         â”‚          â”‚
â”‚  â”‚                                                    â”‚          â”‚
â”‚  â”‚  while True:                                       â”‚          â”‚
â”‚  â”‚    1. Process frame (blocking â†’ executor)         â”‚          â”‚
â”‚  â”‚    2. Broadcast result to ALL subscribers         â”‚          â”‚
â”‚  â”‚    3. Encode JPEG every 4th frame                 â”‚          â”‚
â”‚  â”‚    4. Broadcast preview to UI subscribers         â”‚          â”‚
â”‚  â”‚    5. GC every 30s                                â”‚          â”‚
â”‚  â”‚    6. Sleep to limit FPS                          â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                              â”‚                                    â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â†“                   â†“                          â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚ Result Broadcast â”‚  â”‚ Preview Broadcastâ”‚              â”‚
â”‚         â”‚  (Every frame)   â”‚  â”‚  (Every 4th)     â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                           â”‚
                    â†“                           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   RESULT SUBSCRIBERS      â”‚   â”‚  PREVIEW SUBSCRIBERS â”‚
    â”‚  (SessionManager queue)   â”‚   â”‚   (WebSocket queue)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¥ Frame Processing Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            SIMPLE MEDIAPIPE LIVENESS (Blocking)                  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  1. CAPTURE FRAMES                                  â”‚         â”‚
â”‚  â”‚     frames = pipe.wait_for_frames(timeout=1s)      â”‚         â”‚
â”‚  â”‚     frames = align_to_color.process(frames)        â”‚         â”‚
â”‚  â”‚                                                     â”‚         â”‚
â”‚  â”‚     depth_frame  â”€â”€â”€â”€â”                             â”‚         â”‚
â”‚  â”‚     color_frame  â”€â”€â”€â”€â”¤                             â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                        â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  2. FACE DETECTION (MediaPipe)                      â”‚         â”‚
â”‚  â”‚     rgb = cv2.cvtColor(color, BGR2RGB)             â”‚         â”‚
â”‚  â”‚     mesh_result = face_mesh.process(rgb)           â”‚         â”‚
â”‚  â”‚                                                     â”‚         â”‚
â”‚  â”‚     if no face:                                     â”‚         â”‚
â”‚  â”‚       return Result(face_detected=False)           â”‚         â”‚
â”‚  â”‚                                                     â”‚         â”‚
â”‚  â”‚     Extract landmarks â†’ Compute bbox               â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                        â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  3. LIVENESS CHECK (3 Simple Tests)                â”‚         â”‚
â”‚  â”‚                                                     â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚
â”‚  â”‚  â”‚ CHECK 1: Sufficient Data                    â”‚  â”‚         â”‚
â”‚  â”‚  â”‚   valid_depths = depth_patch[depth > 0]     â”‚  â”‚         â”‚
â”‚  â”‚  â”‚   if len(valid_depths) < 100:               â”‚  â”‚         â”‚
â”‚  â”‚  â”‚     âŒ FAIL: "insufficient_depth_data"       â”‚  â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
â”‚  â”‚                                                     â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚
â”‚  â”‚  â”‚ CHECK 2: Distance Range                     â”‚  â”‚         â”‚
â”‚  â”‚  â”‚   mean_dist = np.mean(valid_depths)         â”‚  â”‚         â”‚
â”‚  â”‚  â”‚   if mean_dist < 0.25m:                     â”‚  â”‚         â”‚
â”‚  â”‚  â”‚     âŒ FAIL: "too_close"                     â”‚  â”‚         â”‚
â”‚  â”‚  â”‚   if mean_dist > 1.2m:                      â”‚  â”‚         â”‚
â”‚  â”‚  â”‚     âŒ FAIL: "too_far"                       â”‚  â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
â”‚  â”‚                                                     â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚
â”‚  â”‚  â”‚ CHECK 3: Depth Variance (Anti-Spoof)        â”‚  â”‚         â”‚
â”‚  â”‚  â”‚   depth_std = np.std(valid_depths)          â”‚  â”‚         â”‚
â”‚  â”‚  â”‚   if depth_std < 0.015m:                    â”‚  â”‚         â”‚
â”‚  â”‚  â”‚     âŒ FAIL: "flat_surface" (photo/screen)  â”‚  â”‚         â”‚
â”‚  â”‚  â”‚                                              â”‚  â”‚         â”‚
â”‚  â”‚  â”‚   âœ… PASS: "live_face"                       â”‚  â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                        â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  4. RETURN RESULT                                   â”‚         â”‚
â”‚  â”‚     SimpleLivenessResult(                          â”‚         â”‚
â”‚  â”‚       face_detected=True,                          â”‚         â”‚
â”‚  â”‚       is_live=True/False,                          â”‚         â”‚
â”‚  â”‚       reason="live_face" / "flat_surface" / ...,   â”‚         â”‚
â”‚  â”‚       mean_distance_m=0.65,                        â”‚         â”‚
â”‚  â”‚       depth_variance_m=0.023,                      â”‚         â”‚
â”‚  â”‚       color_image=<frame>,                         â”‚         â”‚
â”‚  â”‚       bbox=(x0, y0, x1, y1)                        â”‚         â”‚
â”‚  â”‚     )                                               â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ Preview Rendering

```
SimpleLivenessResult
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mode Selection                            â”‚
â”‚  â€¢ "eye_tracking" (default)                â”‚
â”‚  â€¢ "normal" (face dot)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NORMAL MODE     â”‚    â”‚  EYE TRACKING MODE  â”‚
â”‚  (Face Dot)      â”‚    â”‚  (Eye of Horus)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚    â”‚                     â”‚
â”‚ Black canvas     â”‚    â”‚ Black canvas        â”‚
â”‚     â”‚            â”‚    â”‚     â”‚               â”‚
â”‚     â†“            â”‚    â”‚     â†“               â”‚
â”‚ if no face:      â”‚    â”‚ if no face:         â”‚
â”‚   â€¢ Red dot      â”‚    â”‚   â€¢ Ghost eyes      â”‚
â”‚   â€¢ "No Face"    â”‚    â”‚   â€¢ "looking for    â”‚
â”‚                  â”‚    â”‚     face..."        â”‚
â”‚ if face:         â”‚    â”‚   â€¢ "adjust your    â”‚
â”‚   â€¢ Dot at bbox  â”‚    â”‚     position"       â”‚
â”‚     center       â”‚    â”‚                     â”‚
â”‚   â€¢ Green=live   â”‚    â”‚ if face:            â”‚
â”‚   â€¢ Orange=not   â”‚    â”‚   â€¢ Full eyes track â”‚
â”‚   â€¢ Show dist    â”‚    â”‚     face position   â”‚
â”‚                  â”‚    â”‚   â€¢ Progress bar    â”‚
â”‚                  â”‚    â”‚   â€¢ Breathing anim  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ cv2.imencode  â”‚
            â”‚  (.jpg, 70%)  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  JPEG bytes   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
            Broadcast to UI
```

---

## ğŸ”„ Validation Flow (10 seconds)

```
SessionManager._validate_human_presence()
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ACTIVATE CAMERA                                        â”‚
â”‚     â€¢ Check if pre-warmed                                  â”‚
â”‚     â€¢ If cold: activate + 2s warmup                        â”‚
â”‚     â€¢ If warm: activate + 0.5s stabilize                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. COLLECT FRAMES (10 seconds)                            â”‚
â”‚                                                             â”‚
â”‚     passing_frames = []                                    â”‚
â”‚     best_score = -1.0                                      â”‚
â”‚                                                             â”‚
â”‚     for each 0.1s window:                                  â”‚
â”‚       results = await gather_results(0.1)                  â”‚
â”‚                                                             â”‚
â”‚       for result in results:                               â”‚
â”‚         if result.depth_ok:  # Passed liveness             â”‚
â”‚           passing_frames.append(result)                    â”‚
â”‚                                                             â”‚
â”‚           # Update Eye of Horus progress bar               â”‚
â”‚           progress = len(passing_frames) / 10              â”‚
â”‚           set_validation_progress(progress)                â”‚
â”‚                                                             â”‚
â”‚           # Calculate quality score                        â”‚
â”‚           focus = laplacian_variance(color_image)          â”‚
â”‚           score = (stability * 0.7) + (focus * 0.3)        â”‚
â”‚                                                             â”‚
â”‚           if score > best_score:                           â”‚
â”‚             best_score = score                             â”‚
â”‚             best_frame = result                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. VALIDATE RESULTS                                        â”‚
â”‚                                                             â”‚
â”‚     if face_detected_count == 0:                           â”‚
â”‚       âŒ "you dont seem to have facial features"           â”‚
â”‚                                                             â”‚
â”‚     if face_detected_count < 30% of frames:                â”‚
â”‚       âŒ "lost tracking, please stay in frame"             â”‚
â”‚                                                             â”‚
â”‚     if passing_frames < 10:                                â”‚
â”‚       âŒ "validation failed, please try again"             â”‚
â”‚                                                             â”‚
â”‚     âœ… PASS: Use best_frame                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. ENCODE & SAVE                                           â”‚
â”‚     â€¢ Encode best frame as JPEG (95% quality)              â”‚
â”‚     â€¢ Save to captures/{timestamp}_{platform_id}_BEST.jpg  â”‚
â”‚     â€¢ Save metadata JSON                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. DEACTIVATE CAMERA                                       â”‚
â”‚     await set_hardware_active(False, source="validation")  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Performance Optimization Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             OPTIMIZATION TECHNIQUES                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  1. FRAME SKIPPING (75% CPU reduction)               â”‚
â”‚     â€¢ Process: Every frame â†’ validation              â”‚
â”‚     â€¢ Encode: Every 4th frame â†’ preview              â”‚
â”‚                                                      â”‚
â”‚  2. SINGLE MEDIAPIPE MODEL (50% CPU reduction)       â”‚
â”‚     â€¢ Old: face_detector + face_mesh                 â”‚
â”‚     â€¢ New: face_mesh only (does both)                â”‚
â”‚                                                      â”‚
â”‚  3. NO LANDMARK REFINEMENT (40% CPU reduction)       â”‚
â”‚     â€¢ refine_landmarks=False                         â”‚
â”‚     â€¢ Skip iris/lip detail (not needed)              â”‚
â”‚                                                      â”‚
â”‚  4. EXECUTOR PATTERN (non-blocking)                  â”‚
â”‚     â€¢ RealSense SDK is blocking                      â”‚
â”‚     â€¢ Run in executor â†’ event loop continues         â”‚
â”‚                                                      â”‚
â”‚  5. QUEUE SIZE TUNING                                â”‚
â”‚     â€¢ Preview: maxsize=2 (drop old frames)           â”‚
â”‚     â€¢ Results: maxsize=50 (keep all)                 â”‚
â”‚                                                      â”‚
â”‚  6. PERIODIC GC (prevent memory bloat)               â”‚
â”‚     â€¢ gc.collect() every 30 seconds                  â”‚
â”‚     â€¢ Force GC after deactivation                    â”‚
â”‚                                                      â”‚
â”‚  7. FPS LIMITING                                     â”‚
â”‚     â€¢ Target: 30 FPS (33ms per frame)                â”‚
â”‚     â€¢ Sleep if processing faster                     â”‚
â”‚                                                      â”‚
â”‚  8. JPEG QUALITY (bandwidth vs quality)              â”‚
â”‚     â€¢ 70% quality for preview (good enough)          â”‚
â”‚     â€¢ 95% quality for validation (high quality)      â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Reference Counting Example

```
Time    Action                              Requests          Active?
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0.0s    Initial state                       {}                 âŒ
        
1.0s    Debug preview ON                    {preview: 1}       âœ…
        â†’ Camera activates
        
2.0s    Session starts (pre-warm)           {preview: 1,       âœ…
        â†’ Camera already active             validation: 1}
        
3.0s    Validation starts                   {preview: 1,       âœ…
        â†’ Camera already active             validation: 1}
        
13.0s   Validation ends                     {preview: 1}       âœ…
        â†’ Camera stays on (preview active)
        
15.0s   Preview OFF                         {}                 âŒ
        â†’ Camera deactivates
```

**Key Point:** Multiple sources can request camera simultaneously, and it stays active until **all** release it.

---

## ğŸ“Š Data Structures

### SimpleLivenessResult
```python
@dataclass
class SimpleLivenessResult:
    timestamp: float              # Unix timestamp
    color_image: np.ndarray       # BGR image (H, W, 3)
    depth_frame: rs.depth_frame   # Raw depth frame
    bbox: Tuple[int, int, int, int] | None  # (x0, y0, x1, y1)
    
    # Detection
    face_detected: bool           # True if face found
    is_live: bool                 # True if passed liveness
    reason: str                   # "live_face", "flat_surface", etc.
    
    # Metrics
    mean_distance_m: float | None # Average face distance
    depth_variance_m: float | None # Depth standard deviation
    valid_points: int             # Number of valid depth pixels
```

### SimpleLivenessConfig
```python
@dataclass
class SimpleLivenessConfig:
    # Distance thresholds
    distance_min_m: float = 0.25  # 25cm min
    distance_max_m: float = 1.2   # 120cm max
    
    # Depth variance (anti-spoof)
    depth_variance_min_m: float = 0.015  # 15mm variance
    min_valid_points: int = 100
    
    # MediaPipe
    face_confidence: float = 0.5
    
    # Hardware
    resolution_width: int = 640
    resolution_height: int = 480
    fps: int = 30
```

---

This visual guide complements the detailed `REALSENSE_CAMERA_EXPLAINED.md` document! ğŸ¯

